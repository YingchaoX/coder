<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Coder 多场景原型 — 需求文档驱动</title>
  <style>
    :root {
      --bg: #0d1117;
      --fg: #e6edf3;
      --dim: #8b949e;
      --green: #3fb950;
      --red: #f85149;
      --yellow: #d29922;
      --blue: #58a6ff;
      --border: #30363d;
    }
    * { box-sizing: border-box; }
    body {
      font-family: ui-monospace, "Cascadia Code", "SF Mono", Monaco, "Consolas", monospace;
      font-size: 13px;
      line-height: 1.5;
      background: var(--bg);
      color: var(--fg);
      margin: 0;
      padding: 24px;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }
    h1 {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--fg);
    }
    .subtitle {
      color: var(--dim);
      margin-bottom: 32px;
      font-size: 12px;
    }
    .scene {
      margin-bottom: 32px;
      border: 1px solid var(--border);
      border-radius: 6px;
      overflow: hidden;
    }
    .scene-title {
      padding: 8px 12px;
      background: #161b22;
      color: var(--dim);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .term {
      padding: 12px 16px;
      white-space: pre-wrap;
      word-break: break-all;
      min-height: 60px;
    }
    .term .prompt { color: var(--green); }
    .term .user { color: var(--fg); }
    .term .assistant { color: var(--fg); }
    .term .thinking { color: var(--dim); font-style: italic; }
    .term .tool-name { color: var(--blue); }
    .term .tool-ok { color: var(--green); }
    .term .tool-err { color: var(--red); }
    .term .diff-add { color: var(--green); }
    .term .diff-del { color: var(--red); }
    .term .diff-meta { color: var(--dim); }
    .term .sys { color: var(--yellow); }
    .term .error { color: var(--red); }
    nav {
      position: sticky;
      top: 0;
      background: var(--bg);
      padding: 12px 0;
      margin-bottom: 16px;
      border-bottom: 1px solid var(--border);
      z-index: 1;
    }
    nav a {
      color: var(--blue);
      text-decoration: none;
      margin-right: 16px;
      font-size: 12px;
    }
    nav a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <nav>
    <a href="#entry">进入界面</a>
    <a href="#chat">正常 Chat</a>
    <a href="#thinking">Thinking</a>
    <a href="#tools">Tools</a>
    <a href="#diff">Diff</a>
    <a href="#skills">Skills</a>
    <a href="#todos">Todos</a>
    <a href="#mode">模式切换</a>
    <a href="#approval">审批 Ask</a>
    <a href="#shell">Shell !</a>
    <a href="#slash">内建命令</a>
    <a href="#verify">自动验证</a>
    <a href="#errors">异常场景</a>
    <a href="#multiline">多行输入</a>
    <a href="#new-session">新会话 / 权限</a>
    <a href="#patch-skill">Patch 与 Skill 异常</a>
  </nav>

  <h1>Coder 多场景原型</h1>
  <p class="subtitle">仅根据 docs/requirements 需求文档绘制 · 终端 REPL 形态 · 极简样式</p>

  <!-- 1. 进入界面 -->
  <section class="scene" id="entry">
    <div class="scene-title">1. 进入界面 — 第一行 context/model，第二行提示符（含 cwd，用户输入框）</div>
    <div class="term">
<span class="sys">context: 1200 tokens · model: gpt-4o</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span>
    </div>
  </section>

  <!-- 2. 正常 Chat -->
  <section class="scene" id="chat">
    <div class="scene-title">2. 正常 Chat — 用户发送，助手流式追加；↑/↓ 翻阅历史输入（同 Linux）</div>
    <div class="term">
<span class="sys">context: 850 tokens · model: gpt-4o</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span><span class="user">这段代码里的 TODO 有哪些？</span>

<span class="assistant">正在查看工作区中与 TODO 相关的代码...</span>
<span class="assistant">在 main.go 里发现：</span>
<span class="assistant">1. 第 42 行：// TODO: 增加重试逻辑</span>
<span class="assistant">2. 第 67 行：// TODO(perf): 缓存解析结果</span>
<span class="assistant">共 2 处，如需我帮你改可以继续说。</span>

<span class="sys">context: 1200 tokens · model: gpt-4o</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span>
    </div>
  </section>

  <!-- 3. Thinking -->
  <section class="scene" id="thinking">
    <div class="scene-title">3. Thinking — 模型 thinking 在输出流内直接全文展示，不折叠</div>
    <div class="term">
<span class="sys">context: 600 tokens · model: gpt-4o</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span><span class="user">给 handler 加单元测试，覆盖正常和错误分支</span>

<span class="thinking">用户要求为 handler 加单元测试。需要：1) 找到 handler 定义；2) 确定入参和依赖；3) 写测试用例覆盖正常与错误路径。先 read 相关文件。</span>

<span class="assistant">先查看 handler 的实现和包结构。</span>
    </div>
  </section>

  <!-- 4. Tools -->
  <section class="scene" id="tools">
    <div class="scene-title">4. Tools — 工具开始记录名称与摘要，完成时展示结构化摘要</div>
    <div class="term">
<span class="sys">context: 400 tokens · model: gpt-4o</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span><span class="user">在 README 里加一段安装说明</span>

<span class="tool-name">[tool] read</span> path=README.md
<span class="tool-ok">[tool] read ok · 1.2k chars · 12ms</span>

<span class="tool-name">[tool] write</span> path=README.md (update)
<span class="tool-ok">[tool] write ok · updated · 8ms</span>
<span class="assistant">已在 README 中加入「安装说明」小节，包含 uv/Go 的安装步骤。</span>

<span class="sys">context: 1100 tokens · model: gpt-4o</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span>
    </div>
  </section>

  <!-- 5. Diff -->
  <section class="scene" id="diff">
    <div class="scene-title">5. Diff — write/patch 以 unified diff 单列在输出流内展示，工具完成即展示</div>
    <div class="term">
<span class="tool-name">[tool] write</span> path=internal/config/config.go (updated)
<span class="tool-ok">[tool] write ok · updated</span>

<span class="diff-meta">--- a/internal/config/config.go</span>
<span class="diff-meta">+++ b/internal/config/config.go</span>
<span class="diff-meta">@@ -12,6 +12,7 @@ type Config struct {</span>
<span class="diff-meta">     MaxSteps    int    `json:"max_steps"`</span>
<span class="diff-del">-    Timeout     int    `json:"timeout"`</span>
<span class="diff-add">+    Timeout     int    `json:"timeout"`     // seconds</span>
<span class="diff-add">+    CompactThreshold int `json:"compact_threshold"`</span>
<span class="diff-meta"> }</span>

<span class="assistant">已在 Config 中加入 CompactThreshold 字段，并为 Timeout 补充注释。</span>

<span class="sys">context: 1400 tokens · model: gpt-4o</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span>
    </div>
  </section>

  <!-- 6. Skills -->
  <section class="scene" id="skills">
    <div class="scene-title">6. Skills — /skills 按需查看当前可用技能列表</div>
    <div class="term">
<span class="sys">context: 500 tokens · model: gpt-4o</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span><span class="user">/skills</span>

<span class="assistant">当前可用技能：</span>
<span class="assistant">  · commit_message  — 根据 diff 生成符合规范的 commit message</span>
<span class="assistant">  · go_fix_imports  — 整理并修复 Go 文件 import 顺序</span>
<span class="assistant">  · pytest_runner   — 运行 pytest 并解析结果</span>
<span class="assistant">共 3 项，支持语义自动触发与显式调用。</span>

<span class="sys">context: 900 tokens · model: gpt-4o</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span>
    </div>
  </section>

  <!-- 7. Todos -->
  <section class="scene" id="todos">
    <div class="scene-title">7. Todos — 对话流中随回合展示；/todos 只读查看</div>
    <div class="term">
<span class="sys">context: 300 tokens · model: gpt-4o</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span><span class="user">重构 auth 模块并加测试</span>

<span class="assistant">已拆分为子任务，按顺序执行。</span>
<span class="sys">todos: 3 (1 in_progress, 2 pending)</span>
<span class="assistant">  1. [in_progress] 拆分 auth 接口与实现</span>
<span class="assistant">  2. [pending] 为接口编写单元测试</span>
<span class="assistant">  3. [pending] 更新调用方并跑全量测试</span>

<span class="tool-name">[tool] todowrite</span> ...
<span class="tool-ok">[tool] todowrite ok</span>
<span class="sys">todos: 3 (1 done, 1 in_progress, 2 pending)</span>
<span class="assistant">  1. [done] 拆分 auth 接口与实现</span>
<span class="assistant">  2. [in_progress] 为接口编写单元测试</span>
<span class="assistant">  3. [pending] 更新调用方并跑全量测试</span>

<span class="sys">context: 1800 tokens · model: gpt-4o</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span>
    </div>
  </section>

  <!-- 8. 模式切换 -->
  <section class="scene" id="mode">
    <div class="scene-title">8. 模式切换 — /plan、/default、/auto-edit、/yolo，提示符立即体现</div>
    <div class="term">
<span class="sys">context: 500 tokens · model: gpt-4o</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span><span class="user">/plan</span>
<span class="assistant">mode set to plan. 以任务拆解与方案设计为主，不执行写入与副作用命令。</span>

<span class="sys">context: 2100 tokens · model: gpt-4o</span>
<span class="prompt">[plan] /Users/dev/myapp&gt; </span><span class="user">/auto-edit</span>
<span class="assistant">mode set to auto-edit. 可主动调用读写工具并触发自动验证与修复重试。</span>

<span class="sys">context: 2200 tokens · model: gpt-4o</span>
<span class="prompt">[auto-edit] /Users/dev/myapp&gt; </span>
    </div>
  </section>

  <!-- 9. 审批 Ask -->
  <section class="scene" id="approval">
    <div class="scene-title">9. 审批 Ask — 策略 ask 时打印命令与说明，REPL 读一行 y/n/always</div>
    <div class="term">
<span class="tool-name">[tool] bash</span> command=rm -rf ./tmp_cache
<span class="sys">[approval] 需要确认后执行 (bash · ask):</span>
<span class="sys">  rm -rf ./tmp_cache</span>
<span class="sys">  (y=本次放行 / n=拒绝 / always=始终同意该命令)</span>
<span class="sys">context: 1600 tokens · model: gpt-4o</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span><span class="user">y</span>
<span class="tool-ok">[tool] bash ok · exit_code=0 · 45ms</span>

<span class="assistant">已删除 ./tmp_cache。</span>

<span class="sys">context: 1650 tokens · model: gpt-4o</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span>
    </div>
  </section>

  <!-- 10. Shell ! -->
  <section class="scene" id="shell">
    <div class="scene-title">10. Shell 命令 — ! 前缀跳过模型，直接 bash 执行，结果写回会话</div>
    <div class="term">
<span class="sys">context: 200 tokens · model: gpt-4o</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span><span class="user">!go version</span>

<span class="tool-name">[bash]</span> go version
<span class="tool-ok">exit_code=0</span>
<span class="assistant">go version go1.22.1 darwin/arm64</span>

<span class="sys">context: 350 tokens · model: gpt-4o</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span><span class="user">!ls -la</span>

<span class="tool-name">[bash]</span> ls -la
<span class="tool-ok">exit_code=0</span>
<span class="assistant">total 24
drwxr-x  5 dev  staff  160 Feb 11 10:00 .
drwxr-x  3 dev  staff   96 Feb 10 09:00 ..
-rw-r--r--  1 dev  staff  120 README.md
-rw-r--r--  1 dev  staff 2048 main.go</span>

<span class="sys">context: 520 tokens · model: gpt-4o</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span>
    </div>
  </section>

  <!-- 11. 内建命令 -->
  <section class="scene" id="slash">
    <div class="scene-title">11. 内建命令 — /help、/model、/tools、/todos、/new、/diff、/undo 等</div>
    <div class="term">
<span class="sys">context: 100 tokens · model: gpt-4o</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span><span class="user">/help</span>

<span class="assistant">命令：/help /model /permissions /mode(/plan|/default|/auto-edit|/yolo) /tools /skills /todos /new /resume /compact /diff /undo
多行输入：Enter 换行，Ctrl+D 发送。流式中断：Ctrl+C。</span>

<span class="sys">context: 380 tokens · model: gpt-4o</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span><span class="user">/tools</span>

<span class="assistant">当前可用工具：read, write, list, glob, grep, patch, bash, todoread, todowrite, skill, task</span>

<span class="sys">context: 520 tokens · model: gpt-4o</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span><span class="user">/model gpt-4o-mini</span>
<span class="assistant">model set to gpt-4o-mini (persisted to ./.coder/config.json).</span>

<span class="sys">context: 580 tokens · model: gpt-4o-mini</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span><span class="user">/diff</span>
<span class="assistant">工作区改动摘要：
  M internal/config/config.go  (+2 -1)
  M README.md  (+5 -0)
共 2 个文件改动。</span>

<span class="sys">context: 720 tokens · model: gpt-4o-mini</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span>
    </div>
  </section>

  <!-- 12. 自动验证 -->
  <section class="scene" id="verify">
    <div class="scene-title">12. 自动验证 — 编辑后自动跑白名单测试，失败则注入修复提示重试</div>
    <div class="term">
<span class="tool-name">[tool] write</span> path=pkg/auth/auth.go (updated)
<span class="tool-ok">[tool] write ok · updated</span>

<span class="sys">[auto-verify] 执行: go test ./...</span>
<span class="tool-name">[tool] bash</span> go test ./...
<span class="tool-err">[tool] bash · exit_code=1 · 2.1s</span>
<span class="assistant">--- FAIL: TestAuth (0.00s)
    auth_test.go:22: expected status 200, got 401</span>

<span class="sys">[auto-verify] 测试失败，注入修复提示并重试 (1/2)</span>
<span class="assistant">正在根据测试失败原因修复实现...</span>
<span class="tool-name">[tool] write</span> path=pkg/auth/auth.go (updated)
<span class="tool-ok">[tool] write ok</span>
<span class="tool-name">[tool] bash</span> go test ./...
<span class="tool-ok">[tool] bash ok · exit_code=0 · 1.8s</span>
<span class="sys">[auto-verify] 通过</span>

<span class="assistant">已修复并验证通过。</span>

<span class="sys">context: 2400 tokens · model: gpt-4o</span>
<span class="prompt">[auto-edit] /Users/dev/myapp&gt; </span>
    </div>
  </section>

  <!-- 13. 异常场景 -->
  <section class="scene" id="errors">
    <div class="scene-title">13. 异常场景 — 未知命令、步数上限、空输入、/undo 不可用等</div>
    <div class="term">
<span class="sys">context: 200 tokens · model: gpt-4o</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span><span class="user">/unknown</span>
<span class="error">unknown command: /unknown</span>

<span class="sys">context: 350 tokens · model: gpt-4o</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span><span class="user">/resume not-a-valid-id</span>
<span class="error">会话不存在: not-a-valid-id</span>

<span class="sys">context: 500 tokens · model: gpt-4o</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span><span class="user">/undo</span>
<span class="error">/undo 不可用：当前目录不是 git 仓库</span>

<span class="sys">context: 650 tokens · model: gpt-4o</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span><span class="user">   </span>
<span class="assistant">(空输入未发送回合)</span>

<span class="sys">context: 650 tokens · model: gpt-4o</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span><span class="user">(连续多步工具未收敛)</span>
<span class="error">step limit reached</span>

<span class="sys">context: 800 tokens · model: gpt-4o</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span>
    </div>
  </section>

  <!-- 14. 多行输入 -->
  <section class="scene" id="multiline">
    <div class="scene-title">14. 多行输入 — Enter 换行，Ctrl+D 发送</div>
    <div class="term">
<span class="sys">context: 150 tokens · model: gpt-4o</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span><span class="user">请做三件事：
1. 在 README 里加安装说明
2. 给 main 包加一个 -version  flag
3. 跑一遍测试确保通过</span>

<span class="assistant">已识别为多步任务，已初始化 todo 并开始执行。</span>
<span class="sys">todos: 3 (1 in_progress, 2 pending)</span>
<span class="assistant">  1. [in_progress] 在 README 里加安装说明</span>
<span class="assistant">  2. [pending] 给 main 包加 -version flag</span>
<span class="assistant">  3. [pending] 跑测试确保通过</span>
...
    </div>
  </section>

  <!-- 15. 新会话与权限 -->
  <section class="scene" id="new-session">
    <div class="scene-title">15. 新会话与权限 — /new、/permissions 预设</div>
    <div class="term">
<span class="sys">context: 100 tokens · model: gpt-4o</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span><span class="user">/new</span>
<span class="assistant">新会话已创建，上下文已清空。</span>

<span class="sys">context: 0 tokens · model: gpt-4o</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span><span class="user">/permissions</span>
<span class="assistant">当前权限预设: balanced
  预设: strict | balanced | auto-edit | yolo
  read/list/glob/grep: allow  ·  write/patch/bash: ask</span>

<span class="sys">context: 280 tokens · model: gpt-4o</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span><span class="user">/permissions yolo</span>
<span class="assistant">permissions set to yolo. 所有工具默认 allow，bash 风险审批不拦截。</span>

<span class="sys">context: 350 tokens · model: gpt-4o</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span>
    </div>
  </section>

  <!-- 16. Patch 与 Skill 异常 -->
  <section class="scene" id="patch-skill">
    <div class="scene-title">16. Patch 工具与 Skill 异常 — patch 结果、技能不存在回退</div>
    <div class="term">
<span class="tool-name">[tool] patch</span> dry_run=false
<span class="tool-ok">[tool] patch ok · 2 files updated</span>
<span class="diff-meta">--- a/cmd/main.go</span>
<span class="diff-meta">+++ b/cmd/main.go</span>
<span class="diff-meta">@@ -5,6 +5,7 @@</span>
<span class="diff-add">+    "log"</span>
<span class="diff-meta"> ...</span>

<span class="assistant">patch 已应用，已为 main.go 添加 log 引用。</span>

<span class="sys">context: 1100 tokens · model: gpt-4o</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span><span class="user">用 commit_message 技能生成一下 commit message</span>
<span class="sys">[skill] 自动触发: commit_message</span>
<span class="tool-ok">[skill] commit_message ok</span>
<span class="assistant">建议的 commit message: feat(config): add CompactThreshold and timeout comment</span>

<span class="sys">context: 1350 tokens · model: gpt-4o</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span><span class="user">用不存在的_技能名</span>
<span class="error">技能不可用: 不存在的_技能名，已回退到无 skill 路径继续执行。</span>
<span class="assistant">该技能不存在，请检查名称或使用 /skills 查看可用技能。</span>

<span class="sys">context: 1550 tokens · model: gpt-4o</span>
<span class="prompt">[default] /Users/dev/myapp&gt; </span>
    </div>
  </section>

  <p class="subtitle" style="margin-top: 48px;">— 以上场景均来自 docs/requirements 00–07 需求文档 —</p>
</body>
</html>
