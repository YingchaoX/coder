# 04. 安全与权限规则

## 1. 工作区路径安全
所有文件工具通过 `Workspace.Resolve` 做路径收敛：
- 绝对化 + clean
- 处理符号链接（含父目录 symlink）
- `filepath.Rel` 校验是否越过工作区根
- 越界返回 `path outside workspace`

## 2. 权限模型（Policy）
每个工具按策略返回：
- `allow`
- `ask`
- `deny`

可配置维度：`read/edit/write/list/glob/grep/patch/todoread/todowrite/skill/task/bash`。

`bash` 额外支持 pattern（最长匹配优先），并支持 `command_allowlist`（命令名归一化后自动放行 ask）。

## 3. bash 风险审批（工具层）
`bash` 工具在执行前可能返回 `ApprovalRequest`：
- 包含命令替换（`$(` 或反引号）
- shell 词法解析失败（如引号未闭合）
- 命中危险关键词（`rm|mv|chmod|chown|dd|mkfs|shutdown|reboot`）
- 覆盖重定向目标文件已存在（`>`, `1>`, `2>`）

## 4. 审批回调行为（bootstrap 默认实现）
- 非 TTY：拒绝所有需审批请求（避免静默放行）。
- TTY + 策略 ask：支持 `y/n/always`。
- TTY + 风险命令：仅支持 `y/n`（不支持 `always`）。
- `always` 仅对策略 ask 生效，会写入项目级 allowlist（`./.coder/config.json`）。

## 5. 命令模式 `!` 的例外
`!` 命令不经过 Policy 与风险审批链，但仍受：
- Agent 工具开关（`bash` 是否启用）
- `bash` 工具超时/输出限制
- 工作区执行目录约束

## 6. `/permissions` 预设
- `strict`
- `balanced`
- `auto-edit`
- `yolo`

说明：这是运行时策略切换，不改变 `/mode` 本身行为语义。

## 7. 当前已知边界
- `mode=yolo` 本身不会绕过 Policy；真正放行依赖 `/permissions yolo` 或配置策略。
- `allowlist` 按命令名匹配，不按完整参数串匹配。
