# 04. 安全与权限规则

## 1. 路径安全（文件工具）
目标：任何文件访问都不能逃逸工作区根目录。

规则：
- 先做绝对路径与清理。
- 解析符号链接。
- 通过相对路径判断是否越界。
- 越界即拒绝。

## 2. 权限模型
每个工具由策略决定：
- `allow`：直接执行。
- `ask`：需要审批。
- `deny`：拒绝执行。

`bash` 支持按命令 pattern 单独决策，采用“最长匹配优先”。

补充定义：
- `auto_approve_ask`：仅控制 `ask` 请求的默认行为；`true` 时可自动放行，`false` 时必须等待审批结果。
- `approval.interactive`：是否启用真实审批交互。启用时须在 stdout 打印待执行命令与说明，从 REPL 读一行（如 `y`/`n`/`always`）后继续；非交互（`auto_approve_ask=true` 或 `approval.interactive=false`）时不阻塞、自动放行。

模式与权限关系：
- `plan` / `default` / `auto-edit`：按配置中的 `allow`/`ask`/`deny` 正常执行审批链。
- `yolo`：`bash` 工具走全放行路径；高风险命令不再因 `ask`、`deny`、硬阻断规则被拦截。
- skill 自动触发路径默认免审批，但若命中 `deny` 仍必须拒绝。

`/permissions` 预设定义：
- `strict`：`write`/`patch`/`bash` 默认 `deny`，其余读取类工具 `allow`。
- `balanced`：读取类工具 `allow`，`write`/`patch`/`bash` 默认 `ask`。
- `auto-edit`：读取类工具与 `write`/`patch` 默认 `allow`，`bash` 默认 `ask`。
- `yolo`：所有工具默认 `allow`；`bash` 风险审批与硬阻断不拦截执行。

## 3. bash 风险判定
即使策略允许，还会进行命令风险分析：
- 包含命令替换（`$(` 或反引号）要求审批。
- shell 词法解析失败（未闭合引号等）要求审批。
- 命中危险命令关键词（`rm`/`mv`/`chmod`/`chown`/`dd`/`mkfs`/`shutdown`/`reboot`）要求审批。
- 重定向覆盖已存在文件（`>`/`1>`/`2>`）要求审批。

硬阻断规则（命中即 `deny`）：
- 明确破坏系统可用性的命令模式（如格式化磁盘、直接关机/重启）。
- 越权写入受保护路径且无白名单授权。

`yolo` 例外：
- 当且仅当当前模式为 `yolo` 且工具为 `bash` 时，以上风险审批与硬阻断规则不生效，直接进入执行。

## 4. 条件组合关系
一次工具调用中，可能同时经过两类审批判断：
1. 策略层（Policy `ask`）
2. 工具层（ApprovalRequest，如 bash 风险）

默认情况下，任一环节拒绝都不会执行工具；`yolo + bash` 为放行例外。

适用范围：
- 审批链仅作用于**模型触发的工具调用**（包括语义自动触发的 `skill`），例如模型调用 `bash` 执行命令。
- **命令模式 `!`** 视为用户直接在终端执行 shell 命令，不经过策略层与风险审批链，仅受工作区路径等基础安全约束。

审批交互选项（运行时）：
1. 同意一次（输入如 `y`）：仅本次放行。
2. 拒绝（输入如 `n`）：本次终止并记录审计日志。
3. 始终同意该命令（输入如 `always`）：写入 allowlist，后续匹配自动放行，仅适用于策略层 `ask` 的普通命令，不适用于危险命令二次确认。

免审批例外：
- 语义自动触发的 `skill` 加载默认不阻塞 REPL 等待审批输入。
- 该例外仅豁免“交互确认步骤”，不豁免策略拒绝（`deny`）与安全硬阻断。

## 5. “始终同意该命令”匹配规则（项目级）
作用域：
- allowlist 仅在当前项目根路径生效，不跨项目共享。
- 不区分用户身份。

归一化与匹配：
- 按“命令名”匹配，不按整条命令文本匹配参数。
- 大小写不敏感（如 `LS` 与 `ls` 视为同一命令）。
- 前置环境变量赋值不影响命令名（如 `FOO=1 ls` 视为 `ls`）。
- 绝对路径与命令名等价（如 `/bin/ls` 视为 `ls`）。
- 参数顺序不参与判断。

多命令场景：
- `sudo` 命令不纳入 allowlist 自动放行范围，需按高风险路径处理。
- 对管道或链式命令（如 `|`、`&&`、`||`、`;`），必须对每个子命令分别命中 allowlist 才可自动放行。
- 示例：`ls | grep a` 需要 `ls` 和 `grep` 都已被“始终同意”。

## 6. 决策优先级（高到低）
1. 命中 `yolo + bash`（直接放行）。
2. `deny`（策略拒绝或硬阻断规则命中）。
3. 用户本次明确拒绝。
4. 命中“免审批例外”（语义自动触发且被允许的 `skill`）。
5. 命中 allowlist（“始终同意该命令”）。
6. 用户本次同意一次。
7. `ask` 且 `auto_approve_ask=true` 的默认自动放行。
8. 其余 `allow` 路径直接执行。

## 7. 验收标准
- 首次执行 `ask` 命令时，若启用交互审批，必须在 stdout 打印待执行命令与说明，并出现单行输入提示（如 y/n/always）。
- 选择“始终同意该命令”后，相同命令二次执行应自动放行并可追溯审计记录。
- 非 `yolo + bash` 路径下，命中硬阻断规则时，即使命中 allowlist 也不得执行。
- `yolo` 模式下，`bash` 命令不再弹审批，且命中高风险规则仍执行。
- 语义自动触发 skill 时默认不弹审批；若 skill 被策略显式 `deny`，必须拒绝并给出可读提示。
- 示例：记录 `ls` 后，`ls /home` 与 `ls /root` 都应自动放行。
- 示例：记录 `ls` 但未记录 `grep` 时，`ls | grep a` 不应自动放行。
