# 06. 配置与运行规则

## 1. 配置加载顺序（实际实现）
`config.Load(path)` 顺序如下：
1. 载入内置默认值。
2. 合并全局配置：`~/.coder/config.json`（存在则合并）。
3. 选择项目配置路径（优先级）：
   - 环境变量 `AGENT_CONFIG_PATH`
   - CLI `-config` 参数
   - 自动发现：`agent.config.json` -> `.coder/config.json`
4. 合并项目配置。
5. 应用环境变量覆盖并归一化。

## 2. 关键环境变量
- `AGENT_BASE_URL`
- `AGENT_MODEL`
- `AGENT_API_KEY`（回退 `DASHSCOPE_API_KEY`）
- `AGENT_WORKSPACE_ROOT`
- `AGENT_MAX_STEPS`
- `AGENT_CACHE_PATH`

## 3. 归一化规则
- `provider.model/models` 自动补齐、去重。
- `runtime.max_steps/context_token_limit`、`safety`、`workflow.max_verify_attempts` 等缺省值回填。
- 路径字段做 `~` 展开和绝对化。
- `permission.command_allowlist` 归一化为小写命令名并去重。

## 4. `/model` 持久化
- `/model <name>` 会立即切换当前会话模型。
- 并尝试写入 `./.coder/config.json` 的 `provider.model`。
- 写入失败时不回滚当前会话模型，仅返回告警文本。

## 5. 运行时命令规则
- `/new`：创建新 session，清空当前内存消息。
- `/resume <sid>`：从存储加载该 session 消息。
- `/compact`：立即执行上下文压缩。
- `/diff`：调用 `git diff --stat && git diff`。
- `/undo`：调用 `git restore . && git clean -fd`（整仓撤销未提交改动）。

## 6. skills 与 instructions
- 默认技能路径：`./.coder/skills`、`~/.coder/skills`。
- 内置 skills 通过 `go:embed` 注入（当前包含 `create-skill`）。
- context assembler 会注入：
  - system prompt
  - 项目 `AGENTS.md`
  - 全局规则文件（`<storage.base_dir>/AGENTS.md`）
  - `instructions` 与 `permission.instruction_files` 指定文件

## 7. 运行前置条件
- 模型服务可达。
- `/bin/sh` 可执行。
- `storage.base_dir` 可写。
- 若使用 `/undo`、`/diff`，当前目录需可执行 git 命令。
