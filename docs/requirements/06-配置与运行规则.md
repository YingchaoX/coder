# 06. 配置与运行规则

## 1. 配置发现与生效顺序
1. 先加载内置默认值。
2. 查找配置文件：
   - 优先读取当前路径 `./.coder/config.json`。
   - 若不存在，再读取家目录 `~/.coder/config.json`。
3. 应用环境变量覆盖。

说明：
- 文件路径采用“当前路径优先、家目录回退”的单一路径选择逻辑。

`/model` 持久化写入规则：
- `/model <name>` 只写当前项目配置文件：`./.coder/config.json`。
- 不写家目录配置文件，也不需要 `--global/--session/--turn` 等额外作用域参数。
- 若 `./.coder/config.json` 不存在，可自动创建目录与文件。
- 若写入失败，保留当前会话中的模型切换结果，并返回持久化失败告警。

## 2. 配置块职责
- `provider`：模型地址、默认模型、超时、模型列表。
- `runtime`：工作区、最大步骤、上下文 token 限制。
- `safety`：命令超时、输出截断上限。
- `compaction`：自动压缩阈值与保留消息数。
- `workflow`：复杂任务 todo、自动验证开关与命令、模式轮转顺序（`plan/default/auto-edit/yolo`）。
- `permission`：工具级权限与 bash pattern。
- `agents`：默认 agent 与自定义 agent 定义。
- `skills`：技能扫描路径。
- `storage`：SQLite 目录等。

UI 配置约束：
- 当前版本不提供主题切换与字体配置；固定为 `OpenCode Dark` + 终端默认等宽字体。

命令相关运行规则：
- `/new`、`/resume`、`/compact`、`/diff`、`/review`、`/undo` 为首发内建命令集合的一部分。
- `/resume` 仅支持 `/resume <session-id>` 形式，不支持索引或别名。
- `/permissions` 预设固定为：`strict`、`balanced`、`auto-edit`、`yolo`。
- `/undo` 撤销“上一次用户输入整回合”引入的文件改动（含该回合新增文件）；仅在 git 可用且当前工作区是 git 仓库时启用。

## 3. 归一化规则
- 缺省值自动补齐（如 max steps、timeout 等）。
- 路径会做 `~` 展开和绝对化。
- 模型列表去重，并确保包含当前模型。
- 空命令/空路径会被过滤。

## 4. 环境变量
主要包括：
- `AGENT_BASE_URL`
- `AGENT_MODEL`
- `AGENT_API_KEY`（可回退 `DASHSCOPE_API_KEY`）
- `AGENT_WORKSPACE_ROOT`
- `AGENT_MAX_STEPS`
- `AGENT_CACHE_PATH`

## 5. 运行前置条件
- 能访问模型服务（OpenAI 兼容接口）。
- 本地可执行 `/bin/sh`（bash 工具依赖）。
- SQLite 可写目录。
- 若需要 `/undo`：本地需安装 git 且工作区必须是有效 git 仓库。
