# 02. 交互逻辑与状态流

## 1. 统一入口分发
`RunInput(ctx, input, out)` 按如下顺序分发：
1. 若命中 `/` 命令，进入 `runSlashCommand`。
2. 否则若命中 `!` 命令，进入 `runBangCommand`。
3. 否则进入普通回合 `RunTurn`。

## 2. 普通回合（RunTurn）
1. 追加 user 消息。
2. 推送 context/todo 更新。
3. 若满足复杂任务 + todo 条件，自动初始化 todo（`todoread`/`todowrite`）。
4. 进入循环（直到无工具调用或步数上限）：
   - 可能触发上下文压缩（`maybeCompact`）。
   - 调 provider（流式 text/reasoning/tool calls）。
   - 追加 assistant 消息。
   - 若无工具调用则结束；有工具调用则逐个执行。

## 3. 工具调用执行顺序
每个 tool call 顺序固定：
1. Agent 工具开关检查（`isToolAllowed`）。
2. Policy 决策（`allow` / `ask` / `deny`）。
3. 工具级审批（`ApprovalRequest`，如 bash 风险检查）。
4. 实际执行工具并追加 tool 消息。

## 4. `!` 命令模式
- 跳过模型调用。
- 直接执行 `bash` 工具。
- 不走 Policy/风险审批链，但仍受：
  - 当前 Agent 是否允许 `bash`
  - `bash` 工具自身超时/输出限制
  - 工作区 cwd 约束
- 结果按 `[COMMAND]` 块展示，并写入会话消息。

## 5. `/` 内建命令行为
- `/model <name>`：切换当前 provider model，并尝试持久化到 `./.coder/config.json`。
- `/permissions [preset]`：查看或套用 `strict|balanced|auto-edit|yolo`。
- `/new`：创建新会话并清空当前内存消息。
- `/resume [session-id]`：
  - 带参数：从存储加载该会话消息。
  - 不带参数：返回最近会话列表（含 session-id），便于用户选择并继续执行 `/resume <session-id>`。
  - 会话列表中的时间默认按北京时间显示（`Asia/Shanghai`, `UTC+08:00`）。
- `/sessions`：返回最近会话列表（只读，不切换当前会话；时间默认北京时间）。
- `/compact`：强制压缩消息上下文。
- `/diff`：执行 `git diff --stat && git diff`，返回 bash JSON 原始结果。
- `/undo`：执行 `git restore . && git clean -fd`（整工作区回滚）。

## 6. 自动验证
触发条件（全部满足）：
- 本回合执行过 `write`/`edit`/`patch`。
- 改动不全是文档类路径（`docs/`、`.md/.mdx/.txt/.rst/.adoc` 视为文档）。
- `workflow.auto_verify_after_edit=true`。
- `bash` 工具可用且允许。
- `verifyAttempts < max_verify_attempts`。

命令选择：
1. `workflow.verify_commands` 中首个非空命令。
2. 否则按项目文件启发式：
   - `go.mod` -> `go test ./...`
   - `pyproject.toml/pytest.ini/requirements.txt` -> `pytest`
   - `package.json` -> `npm test -- --watch=false`

说明：当前实现未做“固定白名单强校验”。

## 7. 复杂任务判定（isComplexTask）
命中任一条件视为复杂任务：
- 字符数（rune）`>= 80`
- 包含复杂关键词（中英混合）
- 分隔符（`， , ; ；`）计数 `>= 2`
- 单词数 `>= 14`

## 8. 回合终止条件
- assistant 无工具调用。
- 达到 `max_steps`。
- provider 不可用或调用失败。
- 运行态收到 `Esc` 全局取消。

## 9. 持久化行为
- 每次关键节点会执行会话快照落盘：`.coder/sessions/<sid>.json`。
- 同步 best-effort 保存到 SQLite `messages`，供 `/resume` 恢复。

## 10. Esc 全局取消语义
- 生效范围：模型流式输出、tool-call 执行、审批等待（`y/N`）与后续自动重试链路。
- `y/N` 场景中按 `Esc` 等价于“全局 Cancel”，不是 `N`。
- 取消策略：停止后续动作，不回滚已发生副作用。
- 并行/子流程：一键全停（包含已启动子任务与排队步骤）。
- 取消后统一输出：
  - `Cancelled by ESC`
  - `Stopped model stream and tool execution; todo state remains unchanged unless a tool had already completed.`
