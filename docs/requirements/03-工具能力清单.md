# 03. 工具能力清单

## 1. 内置工具列表
- 文件类：`read` `write` `list` `glob` `grep` `patch`
- 执行类：`bash`
- 任务管理：`todoread` `todowrite`
- 扩展能力：`skill` `task`

## 2. 工具行为矩阵（需求视角）
| 工具 | 主要输入 | 主要输出 | 成功条件 | 常见失败场景 |
|---|---|---|---|---|
| read | `path` | 文件内容 | 路径在工作区内且可读 | 路径越界、文件不存在、读取失败 |
| write | `path`,`content` | 写入结果+diff摘要 | 路径合法且可写 | 路径越界、目录创建失败、写入失败 |
| list | `path`(可空) | 目录条目列表 | 目录存在且可读 | 路径越界、目录不可读 |
| glob | `pattern` | 匹配路径列表 | pattern 非空且非绝对路径 | pattern 无效、绝对路径被拒绝 |
| grep | `pattern`,`path`,`max_matches` | 命中列表 | 正则可编译，路径可遍历 | 正则编译失败、路径越界 |
| patch | `patch`,`dry_run` | 应用结果（文件数/每文件结果） | unified diff 合法且上下文匹配 | hunk 不匹配、目标文件不存在/越界 |
| bash | `command` | exit_code/stdout/stderr | 命令可执行并在超时内返回 | 空命令、超时、策略拒绝 |
| todoread | 无 | 当前会话 todo 列表 | 会话可识别 | store 不可用、会话 ID 缺失 |
| todowrite | `todos[]` | 更新后的 todo 列表 | todo 合法（最多 1 个 in_progress） | 状态冲突、存储失败 |
| skill | `action,name` | 技能列表或技能内容 | 技能存在且权限允许 | 技能不存在、权限拒绝 |
| task | `agent,objective` | 子任务摘要结果（`summary`） | agent 合法且 runner 可用，返回摘要文本 | agent 为空/非法、objective 为空、runner 不可用 |

## 3. 输出特性
- 大文本命令输出会被截断并标记 `[output truncated]`。
- `write` 会返回 `operation`（created/updated/unchanged）和简化 diff。
- TUI 对 `write`/`patch` 的 diff 结果使用左右并排对比视图，基础高亮仅包含 `+`/`-`/`@@`。
- TUI 时间线默认展示工具摘要（工具名、关键参数、核心结果、耗时），并支持展开查看完整 payload。

`task` 输出契约（稳定消费）：
- 必填：`summary`（字符串）。
- 推荐：同时返回 `agent`（字符串）用于标识执行子代理名称。
- `summary` 需为可直接消费的简明结论，不要求结构化字段拆分。

## 4. 文档编辑识别规则（影响自动验证）
以下路径通常被视为文档类改动：
- `docs/` 目录
- 后缀：`.md` `.mdx` `.txt` `.rst` `.adoc`

若本回合仅改动文档类文件，可跳过自动验证。

## 5. skill 触发策略
- 支持“基于语义自动触发”与“显式工具调用”两种入口。
- 自动触发 skill 默认免审批，不要求用户二次确认。
- 若 skill 名称不存在、内容加载失败或被策略 `deny`，系统必须显式告知并回退到无 skill 路径继续执行。
