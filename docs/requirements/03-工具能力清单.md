# 03. 工具能力清单

## 1. 内置工具列表
- 文件类：`read` `write` `list` `glob` `grep` `patch`
- 执行类：`bash`
- 任务管理：`todoread` `todowrite`
- 扩展能力：`skill` `task`

## 2. 工具行为矩阵（需求视角）
| 工具 | 主要输入 | 主要输出 | 成功条件 | 常见失败场景 |
|---|---|---|---|---|
| read | `path` | 文件内容 | 路径在工作区内且可读 | 路径越界、文件不存在、读取失败 |
| write | `path`,`content` | 写入结果+diff摘要 | 路径合法且可写 | 路径越界、目录创建失败、写入失败 |
| list | `path`(可空) | 目录条目列表 | 目录存在且可读 | 路径越界、目录不可读 |
| glob | `pattern` | 匹配路径列表 | pattern 非空且非绝对路径 | pattern 无效、绝对路径被拒绝 |
| grep | `pattern`,`path`,`max_matches` | 命中列表 | 正则可编译，路径可遍历 | 正则编译失败、路径越界 |
| patch | `patch`,`dry_run` | 应用结果（文件数/每文件结果） | unified diff 合法且上下文匹配 | hunk 不匹配、目标文件不存在/越界 |
| bash | `command` | exit_code/stdout/stderr | 命令可执行并在超时内返回 | 空命令、超时、策略拒绝 |
| todoread | 无 | 当前会话 todo 列表 | 会话可识别 | store 不可用、会话 ID 缺失 |
| todowrite | `todos[]` | 更新后的 todo 列表 | todo 合法（最多 1 个 in_progress） | 状态冲突、存储失败 |
| skill | `action,name` | 技能列表或技能内容 | 技能存在且权限允许 | 技能不存在、权限拒绝 |
| task | `agent,objective` | 子任务摘要结果（`summary`） | agent 合法且 runner 可用，返回摘要文本 | agent 为空/非法、objective 为空、runner 不可用 |

## 3. 输出特性
- 大文本命令输出会被截断并标记 `[output truncated]`。
- `write` 会返回 `operation`（created/updated/unchanged）和简化 diff。
- REPL 下 `write`/`patch` 的 diff 以 **unified diff 文本**（单列 +/-/@@）在输出流中展示，不做左右并排视图。
- 若有完整输出（如 write 的 diff），在同一输出流内直接以 unified diff 或原文展示，无需展开。

`task` 输出契约（稳定消费）：
- 必填：`summary`（字符串）。
- 推荐：同时返回 `agent`（字符串）用于标识执行子代理名称。
- `summary` 需为可直接消费的简明结论，不要求结构化字段拆分。

## 4. 文档编辑识别规则（影响自动验证）
以下路径通常被视为文档类改动：
- `docs/` 目录
- 后缀：`.md` `.mdx` `.txt` `.rst` `.adoc`

若本回合仅改动文档类文件，可跳过自动验证。

## 5. skill 触发策略
- 支持“基于语义自动触发”与“显式工具调用”两种入口。
- 自动触发 skill 默认免审批，不要求用户二次确认。
- 若 skill 名称不存在、内容加载失败或被策略 `deny`，系统必须显式告知并回退到无 skill 路径继续执行。

## 6. 预装技能（内置 skill）
- **目标**：交付物仅一个 coder 二进制时，仍能通过自然语言 prompt 让 Agent 按规范创建新 skill（如“帮我写一个 xxx 的 skill”）。
- **实现方式**：预装技能内嵌在二进制中（代码库内资源 + `go:embed`），不依赖 `.coder/skills/` 或任何外部目录。
- **预装内容**：至少预装 `create-skill`，用于引导 Agent 创建新技能（SKILL.md 结构、描述规范、存放路径等）；技能正文中所有路径与产品名均使用 coder 约定（如 `~/.coder/skills/`、`.coder/skills/`），不出现 Cursor 相关表述。
- **合并规则**：启动时先按 `skills.paths` 发现用户技能，再合并内置技能；若某 name 已在用户路径中存在，则保留用户版本（用户可覆盖预装）。
- **用户扩展**：用户可通过 `skills.paths` 配置增加或覆盖技能，新创建的 skill 可放在 `.coder/skills/`（项目）或 `~/.coder/skills/`（个人）。
