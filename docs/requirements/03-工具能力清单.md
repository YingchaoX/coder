# 03. 工具能力清单

## 1. 内置工具列表
- 文件类：`read` `list` `glob` `grep` `write` `edit` `patch`
- 执行类：`bash`
- 任务类：`todoread` `todowrite` `skill` `task`
- 交互类：`question`
- LSP类：`lsp_diagnostics` `lsp_definition` `lsp_hover`
- Git类：`git_status` `git_diff` `git_log` `git_add` `git_commit`
- 网络类：`fetch`

## 2. 工具行为矩阵（当前实现）
| 工具 | 关键输入 | 关键输出 | 约束/说明 |
|---|---|---|---|
| `read` | `path`, `offset?`, `limit?` | `content`, `start_line`, `end_line`, `has_more` | 默认 `limit=50`，上限 200；`offset<0` 进入 tail 模式（取最后 N 行） |
| `list` | `path?` | 目录条目数组 | 默认路径 `.` |
| `glob` | `pattern` | `matches[]` | 禁止绝对路径 pattern |
| `grep` | `pattern`, `path?`, `max_matches?` | 命中数组+计数 | 默认 `path=.`，默认 `max_matches=200` |
| `write` | `path`, `content` | `operation`, `diff`, `additions`, `deletions` | 全量写文件；返回 unified diff（可截断） |
| `edit` | `path`, `old_string`, `new_string`, `replace_all?` | `replacements`, `diff` | 面向小范围替换；`old_string` 必须可定位 |
| `patch` | `patch`, `dry_run?` | `applied`, `files[]` | 解析 unified diff 后逐文件应用 |
| `bash` | `command` | `exit_code`, `stdout`, `stderr`, `truncated`, `duration_ms` | `/bin/sh -lc` 执行，受超时/输出上限限制 |
| `todoread` | 无 | 当前会话 todos | 基于当前 session ID |
| `todowrite` | `todos[]` | 更新后 todos | 最多允许 1 个 `in_progress` |
| `skill` | `action=list/load`, `name?` | 技能列表或技能内容 | `load` 受权限策略约束 |
| `task` | `agent`, `objective` | `summary` | 运行子代理任务，返回摘要 |
| `lsp_diagnostics` | `path` | `diagnostics[]` | 获取文件诊断信息（错误/警告），默认语言：sh、py |
| `lsp_definition` | `path`, `line`, `character` | `location` | 跳转到符号定义位置，返回文件路径和行列号 |
| `lsp_hover` | `path`, `line`, `character` | `contents` | 获取符号的悬停信息（类型/文档） |
| `git_status` | `short?` | `content` | 查看工作区状态，`short=true` 输出简洁格式 |
| `git_diff` | `staged?`, `path?` | `content` | 查看文件变更，`staged=true` 查看暂存区变更 |
| `git_log` | `limit?`, `oneline?` | `content` | 查看提交历史，默认 limit=20 |
| `git_add` | `path` | `ok`, `files` | 添加文件到暂存区，需要审批 |
| `git_commit` | `message` | `ok`, `commit` | 提交变更，需要审批，禁止危险参数 |
| `fetch` | `url`, `method?`, `headers?`, `body?`, `timeout_sec?`, `max_size_kb?`, `auth?` | `url`, `status_code`, `content_type`, `is_image`, `content`, `size_bytes` | 获取HTTP资源，文本内容截断至100KB，图片转base64（最大1MB） |
| `question` | `questions[]`（每项含 `question`, `options[]{label,description}`） | 格式化的用户回答文本 | 仅 plan mode 可用；向用户提问选择题，第一个选项为推荐项；用户可输入数字选择或自定义文本 |

### Question 工具说明
- **仅 plan mode**：`question` 工具默认禁用，仅在 plan mode 的 agent profile 中启用
- **选择题形式**：模型一次可发送多个问题，终端逐个呈现；每个问题包含若干选项，第一个为推荐选项（自动追加 `(Recommended)` 标记）
- **用户回复**：用户输入数字选择对应选项的 label，或直接输入自定义文本作为回复；自定义回复永远可用
- **取消**：用户按 Esc 取消全部问题，已回答的部分也丢弃
- **无交互终端**：非 TTY 环境下返回 fallback 提示，模型自行判断

### Git 工具说明
- **自动检测**：启动时检测 git 可用性和仓库状态，未安装时打印提示
- **降级策略**：非 git 仓库或 git 不可用时，工具返回友好提示，建议使用 `bash` 命令
- **权限控制**：`git_status`/`git_diff`/`git_log` 默认 `allow`（只读操作），`git_add`/`git_commit` 默认 `ask`（需要审批）
- **安全限制**：`git_commit` 禁止使用 `--amend`、`--force`、`--no-verify` 等危险操作

### Fetch 工具说明
- **功能**：获取HTTP/HTTPS资源，支持GET/POST/PUT/DELETE等方法
- **内容处理**：文本内容（HTML/JSON/TEXT等）自动截断至100KB，图片自动转base64编码（最大1MB）
- **认证**：支持Basic、Bearer Token、Cookie等认证方式，401错误时自动重试带认证
- **权限控制**：默认 `ask`，可通过 `permission.fetch` 配置为 `allow` 或 `deny`
- **安全性**：支持跳过TLS验证（内网场景），限制最大响应大小防止单次请求过大

### LSP 工具说明
- **默认启用语言**：sh (bash-language-server)、py (python-lsp-server)
- **降级策略**：LSP Server 未安装时，工具返回降级提示，建议使用 `grep` 或 `read`
- **权限**：LSP 工具默认 `allow`（只读操作）
- **安装提示**：启动时检测 LSP Server 状态，未安装时打印一次安装提示

## 3. 输出与展示约束
- 工具结果在 REPL 中先显示摘要；若有 diff/多行详情则继续展示正文。
- `write`/`edit` 的 diff 为 unified 格式（`---`/`+++`/`@@`/`+`/`-`）。
- `bash` 输出按字节上限截断，截断时附 `[output truncated]`。

## 4. 自动验证相关的“文档改动”识别
以下路径视为文档类改动（可跳过自动验证）：
- `docs/` 目录
- 后缀：`.md` `.mdx` `.txt` `.rst` `.adoc`

## 5. Skills（内置 + 用户）
- 内置 skill：当前至少包含 `create-skill`（`go:embed`）。
- 用户 skill：从 `skills.paths` 扫描 `SKILL.md`。
- 同名冲突时，用户路径优先覆盖内置版本。
