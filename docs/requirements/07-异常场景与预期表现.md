# 07. 异常场景与预期表现

## 1. 交互层异常
| 场景 | 触发条件 | 预期表现 |
|---|---|---|
| 空输入提交 | 输入全空白 | 本轮跳过，不发送 |
| `!` 空命令 | `!` 或 `!   ` | 返回 `command mode error: empty command after '!'` |
| `/` 空命令 | `/` 或 `/   ` | 返回 `Unknown command: /`（附 `/help` 提示） |
| 未知 `/` 命令 | `/unknown` | 返回 `Unknown command: /unknown` |
| `/model` 缺参数 | `/model` | 返回当前模型与用法 |
| `/resume` 缺参数 | `/resume` | 返回 `Usage: /resume <session-id>` |
| `/resume` 会话不存在 | 无匹配 session id | 返回 `Session not found: <sid>` |
| `/permissions` 非法参数 | 预设名不存在 | 返回可用预设列表 |
| 步数耗尽 | 工具循环未收敛 | 返回 `step limit reached` |

## 2. 工具与策略异常
| 场景 | 触发条件 | 预期表现 |
|---|---|---|
| 未知工具 | registry 不存在 | `unknown tool` 错误 |
| 路径越界 | `../` 或 symlink 逃逸 | `path outside workspace` 相关错误 |
| `edit` 无法定位 | `old_string` 不匹配或歧义 | 返回明确定位错误 |
| `patch` 不匹配 | hunk 上下文冲突 | 返回 context/remove mismatch 错误 |
| `bash` 超时 | 超过 `command_timeout_ms` | `exit_code=124` |
| 需审批但非 TTY | ask 请求在非交互环境 | 默认拒绝执行 |

## 3. Provider 层异常
| 场景 | 触发条件 | 预期表现 |
|---|---|---|
| 流式中途失败（已有部分输出） | SSE 中断 | 返回已聚合内容（best-effort） |
| 流式首包失败 | 创建流即失败 | 返回 provider 错误 |
| context 取消 | 用户中断或外部取消 | 返回取消错误 |

## 4. 自动验证异常
| 场景 | 触发条件 | 预期表现 |
|---|---|---|
| 无可选验证命令 | 配置为空且未识别项目类型 | 跳过自动验证 |
| 验证失败且可重试 | 业务测试失败 | 注入修复提示继续循环（受 `max_verify_attempts` 限制） |
| 验证失败且环境型不可重试 | 缺命令/启动脚本错误等 | 输出 best-effort 警告，停止自动重试 |

## 5. `/undo` 与 git 相关异常
| 场景 | 触发条件 | 预期表现 |
|---|---|---|
| 非 git 仓库（或 rev-parse 失败） | `git rev-parse` 非 0 | 返回 `/undo 不可用：当前目录不是 git 仓库` |
| undo 命令执行失败 | `git restore/clean` 返回错误 | 返回 `Failed to run undo commands: ...` |
