# 07. 异常场景与预期表现

## 1. 交互层异常
| 场景 | 触发条件 | 预期表现 |
|---|---|---|
| 空输入提交 | 输入全空白 | 不发送回合 |
| `!` 后空命令 | 输入仅 `!` 或 `!   ` | 返回命令模式错误文本 |
| `/` 后空命令 | 输入仅 `/` 或 `/   ` | 返回内建命令错误文本 |
| 未知 `/` 命令 | 输入 `/unknown` | 返回 unknown command 错误文本 |
| `/model` 参数非法 | 模型名为空或不可切换 | 返回模型切换失败文本 |
| `/model` 使用废弃作用域参数 | 输入 `--turn/--session/--global` | 返回参数错误并提示仅支持 `/model <name>` |
| `/model` 持久化写入失败 | 切换成功但写 `./.coder/config.json` 失败 | 当前会话模型保持切换成功，同时回显持久化失败告警 |
| `/resume` 参数非法 | 非 `<session-id>` 形式（含索引/别名） | 返回参数错误并提示仅支持 `/resume <session-id>` |
| `/resume` 目标不存在 | 指定 `session-id` 无匹配 | 返回“会话不存在”并保持当前会话不变 |
| `/permissions` 参数非法 | 传入不存在的权限预设 | 返回参数错误并列出可用预设 |
| `/fork` 被调用 | 输入 `/fork ...` | 返回“当前版本仅支持线性会话”的错误提示 |
| `/undo` 在无 git 环境执行 | 系统找不到 git 命令 | 返回“/undo 不可用：git 未安装” |
| `/undo` 在非 git 仓库执行 | 当前目录缺少 `.git` 仓库上下文 | 返回“/undo 不可用：当前目录不是 git 仓库” |
| 达到步数上限 | 连续工具循环未收敛 | 回合报错 `step limit reached` |
| `/mode` 参数非法或未知模式名 | 传入不存在的模式名 | 返回参数错误并列出可用模式（plan/default/auto-edit/yolo） |

## 2. 工具层异常
| 场景 | 触发条件 | 预期表现 |
|---|---|---|
| 未知工具 | 注册表中不存在 | 返回 `unknown tool` 错误 |
| 路径越界 | `../` 或符号链接逃逸 | 返回权限相关错误 |
| patch 不匹配 | hunk 上下文与原文件不一致 | patch 执行失败并停止该调用 |
| 命令超时 | bash 超过超时阈值 | exit_code=124，ok=false |
| 自动触发 skill 不存在 | 语义路由命中不存在的技能名 | 回显技能不可用提示并回退到无 skill 路径 |
| `yolo` 模式执行高风险 `bash` 失败 | 命令已放行但运行时报错 | 返回真实 exit code 与 stderr，不做策略层拦截提示 |

## 3. Provider 层异常
| 场景 | 触发条件 | 预期表现 |
|---|---|---|
| 流式中断（已拿到部分内容） | 中途网络/服务异常 | 返回已接收的部分结果 |
| 流式立即失败（无内容） | 创建流或首包失败 | 返回 provider 错误 |
| 上下文取消 | 外部 context 取消（含用户 Ctrl+C 中断流式） | 立即返回取消错误 |

## 4. 自动验证异常
| 场景 | 触发条件 | 预期表现 |
|---|---|---|
| 测试失败且可重试 | 业务错误输出 | 注入修复提示，继续模型循环 |
| 测试失败且不可重试 | 环境错误（缺命令/shell 启动问题） | 输出警告并 best-effort 结束 |
| 无白名单命令可执行 | 未找到命中固定白名单的验证命令 | 允许跳过，并明确提示“未执行自动验证” |
| 验证命令不在白名单 | 用户指定或配置命令不在固定白名单中 | 拒绝执行该命令，并提示白名单限制 |
