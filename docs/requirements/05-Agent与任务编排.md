# 05. Agent 与任务编排

## 1. 内置 Agent
- `build`：默认主代理，工具集完整。
- `plan`：主代理，禁用 `write`/`patch`。
- `general`：子代理，通用探索。
- `explore`：子代理，只读探索，禁写禁 bash，禁 task。

## 2. Agent 对行为的影响
- 限制模型可见工具定义（禁用工具不会暴露给模型）。
- 即使模型返回了禁用工具调用，也会在执行前被拦截并写入 blocked 结果。
- 输入模式与 Agent 解耦：通过内建命令（如 `/mode` 或 `/plan`、`/default`、`/auto-edit`、`/yolo`）切换模式，不直接切换 Agent。
- 模式切换引起的行为差异（是否可写、是否自动验证）由编排层控制，不依赖 Agent 名称变化。

## 3. 子任务机制（task 工具）
触发条件：模型调用 `task`，传入 `agent` + `objective`。

行为：
- 仅允许 `mode=subagent` 的 agent 名称。
- 子代理会继承大多数运行配置。
- 子代理内部强制禁用 `task`（避免递归）和 todo 工具。
- 子任务结果以摘要对象返回父回合，核心字段为 `summary`。

子任务返回契约（必填字段）：
- `summary`：子任务执行结果摘要（字符串，要求可读且可直接用于后续决策）。
- 可选 `agent`：执行该子任务的子代理名称（字符串）。

父代理消费规则：
- 父代理以 `summary` 为主进行后续规划与决策。
- 缺少 `summary` 时，视为子任务返回不合规并进入错误处理。

## 4. Todo 机制
- 复杂任务可自动初始化 todo。
- `todowrite` 要求 `in_progress` 最多 1 条。
- todo 属于会话级数据，可独立读写。
- Todo 在**对话流中**展示；可通过 `/todos` 命令仅查看当前列表（只读）；用户不通过 UI 调整顺序或状态，由 agent 经 `todowrite` 更新。

## 5. 你可细化的需求切片
- agent 切换入口（UI 命令/快捷键/会话级持久化）。
- 子代理并发能力。
- todo 状态机扩展（阻塞态、取消态、依赖关系）。
