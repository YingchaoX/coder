# 05. Agent 与任务编排

## 1. 内置 Agent
- `build`：默认主代理，工具集完整。
- `plan`：主代理，禁用 `write`/`patch`。
- `general`：子代理，通用探索。
- `explore`：子代理，只读探索，禁写禁 bash，禁 task。

## 2. Agent 对行为的影响
- 限制模型可见工具定义（禁用工具不会暴露给模型）。
- 即使模型返回了禁用工具调用，也会在执行前被拦截并写入 blocked 结果。
- 输入模式与 Agent 解耦：通过内建命令（如 `/mode` 或 `/plan`、`/default`、`/auto-edit`、`/yolo`）切换模式，不直接切换 Agent。
- 模式切换引起的行为差异（是否可写、是否自动验证）由编排层控制，不依赖 Agent 名称变化。

## 3. 子任务机制（task 工具）
触发条件：模型调用 `task`，传入 `agent` + `objective`。

行为：
- 仅允许 `mode=subagent` 的 agent 名称。
- 子代理会继承大多数运行配置。
- 子代理内部强制禁用 `task`（避免递归）和 todo 工具。
- 子任务结果以摘要对象返回父回合，核心字段为 `summary`。

子任务返回契约（必填字段）：
- `summary`：子任务执行结果摘要（字符串，要求可读且可直接用于后续决策）。
- 可选 `agent`：执行该子任务的子代理名称（字符串）。

父代理消费规则：
- 父代理以 `summary` 为主进行后续规划与决策。
- 缺少 `summary` 时，视为子任务返回不合规并进入错误处理。

## 4. Todo 机制

- **使用场景划分**
  - 简单任务：单步或 1–2 步即可完成、不需要跨多回合跟踪的请求。
    - 示例：在 `README` 末尾追加一行日期、修正单个拼写错误、执行一次 `npm install` 并回显结果。
    - 默认行为：直接执行并在回答中简要说明结果，**不创建 todo**。
    - 例外：用户明确要求“先帮我列个 todo 再做”时，可以为简单任务显式创建 todo。
  - 复杂任务：需要多步、跨多文件或预期跨多回合推进的请求。
    - 示例：实现新特性（涉及多处代码修改 + 测试）、大范围重构、系统性性能优化。
    - 默认行为：可以从用户输入（编号列表、多条需求等）中**整理出 todo 列表**，作为本次工作的执行计划。

- **状态与约束**
  - todo 属于会话级数据，可独立读写。
  - 状态仅使用：`pending` / `in_progress` / `completed`。
  - 任意时刻最多仅允许 1 条 `in_progress`，其余为 `pending` 或 `completed`。
  - 优先级（`high` / `medium` / `low`）与状态解耦，仅用于排序和关注度提示。

- **读写方式与可视化**
  - `todoread`：读取当前会话的 todo 列表，用于在复杂任务中**频繁同步**进度。
  - `todowrite`：整表替换当前会话的 todo 列表，要求 `in_progress` 最多 1 条。
  - Todo 在**对话流中**展示；可通过 `/todos` 命令仅查看当前列表（只读）；用户不通过 UI 调整顺序或状态，由 agent 经 `todowrite` 更新。

- **总结行为**
  - 不为“总结任务完成情况”“简单验证结果”等元行为单独创建 todo 项。
  - 当所有主要 todo 均 `completed` 时，Agent 应：
    - 在回答中明确一句“当前会话的 todos 已全部完成”（或等价表述）；
    - 用自然语言简要概括本次完成的工作；
    - 新的、与当前列表无关的任务如需跟踪，应通过新的 todo 列表开始。

- **示例对比**
  - 示例 A（简单修改）：
    - 用户：`在 README.md 的最后追加今天的日期。`
    - 期望行为：Agent 直接读取 `README.md`、应用补丁或追加一行，然后在回答中说明已追加日期，**不创建 todo**。
  - 示例 B（实现新特性）：
    - 用户：`帮我实现一个新的导出命令，要求有 CLI 入口、更新文档，并补充基本测试。`
    - 期望行为：
      - Agent 将请求拆分为若干 todo，如：
        1. 设计导出命令的参数与行为契约。
        2. 在 CLI 中实现导出命令。
        3. 更新相关文档（README / 技术文档）。
        4. 添加或更新测试，确保导出命令行为稳定。
      - 之后按 todo 状态机推进，每完成一步就更新 `todoread` / `todowrite`，并在回答中同步进度。

## 5. 你可细化的需求切片
- agent 切换入口（UI 命令/快捷键/会话级持久化）。
- 子代理并发能力。
- todo 状态机扩展（阻塞态、取消态、依赖关系）。
