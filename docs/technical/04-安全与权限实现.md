# 04. 安全与权限实现（目标态）

## 1. 路径安全
实现核心：`security.Workspace`

规则：
1. 输入路径绝对化与规范化。
2. 解析符号链接。
3. 基于相对路径判断是否越界。
4. 越界直接拒绝（`ErrPathOutsideWorkspace`）。

适用范围：`read/write/list/glob/grep/patch` 等文件工具。

## 2. 权限模型
策略决策值：
- `allow`
- `ask`
- `deny`

决策层次：
1. Agent 工具开关。
2. Policy 工具级决策。
3. 工具级风险审批（如 bash）。
4. 审批原因聚合后单次交互确认（避免同一次工具调用重复弹审）。

## 3. `bash` 策略与匹配
- `bash["*"]` 作为基线规则。
- 其它 pattern 采用“最长匹配优先”。
- 命中后覆盖基线决策。

## 4. 风险审批
命中以下任一条件触发审批：
- 命令替换（`$(` / 反引号）。
- shell 词法解析失败（fail closed）。
- 危险命令识别（基于 shell 分词后的命令名提取，辅以关键词规则；至少覆盖 `rm/mv/chmod/chown/dd/mkfs/shutdown/reboot`）。
- 重定向覆盖已存在文件（`>`/`1>`/`2>`）。

## 5. 硬阻断
- 破坏系统可用性命令（如格式化磁盘、直接关机/重启）。
- 越权写受保护路径且无白名单授权。

## 6. 模式与权限联动
- 仅保留 `build` 与 `plan` 两个运行态预设。
- `/mode` 与 `/permissions` 使用同名预设联动切换，避免“模式与策略脱节”。
- `build` 模式：
  - Agent 侧启用 `edit/write/patch/task` 等交付工具，禁用 `todowrite`（todo 规划仅在 plan 模式）。
  - Agent 侧禁用 `question` 工具（向用户提问仅在 plan 模式）。
- `plan` 通过 Agent + Policy 双层限制实现“工具只读 + bash 审批”：
  - Agent 侧禁用 `edit/write/patch/task` 与变更型 git 工具。
  - Agent 侧启用 `question` 工具，允许在规划前向用户澄清需求。
  - Policy 侧 `bash` 基线为 `ask`，白名单命令 `allow`。

## 7. 审批交互契约
当启用交互审批时，必须提供三选项（仅对**策略层 `ask`** 生效）：
1. 同意一次
2. 拒绝
3. 始终同意该命令（记录到项目级 allowlist，仅影响后续策略层决策；危险命令风险审批仍为 y/n）

## 8. “始终同意该命令”规则
- 项目级作用域，不跨项目。
- 按命令名匹配，不按完整参数。
- 大小写不敏感。
- 前置环境变量不影响匹配。
- 绝对路径命令与命令名等价。
- 管道/链式命令需每个子命令均命中。
- `sudo` 不纳入自动放行。

适用范围：
- 用于策略层 `ask` 的 bash 调用（包括模型触发与命令模式 `!`），由审批交互产生。
- 危险命令风险审批仍为 y/n，不受 allowlist 影响。

## 9. 决策优先级
1. `deny`（策略或硬阻断）。
2. 用户拒绝。
3. 自动触发 skill 免审批例外（前提非 `deny`）。
4. allowlist 命中。
5. 用户同意一次。
6. `ask + auto_approve_ask=true`。
7. 普通 `allow`。
