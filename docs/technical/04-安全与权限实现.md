# 04. 安全与权限实现（目标态）

## 1. 路径安全
实现核心：`security.Workspace`

规则：
1. 输入路径绝对化与规范化。
2. 解析符号链接。
3. 基于相对路径判断是否越界。
4. 越界直接拒绝（`ErrPathOutsideWorkspace`）。

适用范围：`read/write/list/glob/grep/patch` 等文件工具。

## 2. 权限模型
策略决策值：
- `allow`
- `ask`
- `deny`

决策层次：
1. Agent 工具开关。
2. Policy 工具级决策。
3. 工具级风险审批（如 bash）。

## 3. `bash` 策略与匹配
- `bash["*"]` 作为基线规则。
- 其它 pattern 采用“最长匹配优先”。
- 命中后覆盖基线决策。

## 4. 风险审批
命中以下任一条件触发审批：
- 命令替换（`$(` / 反引号）。
- shell 词法解析失败（fail closed）。
- 危险命令关键词（`rm/mv/chmod/chown/dd/mkfs/shutdown/reboot`）。
- 重定向覆盖已存在文件（`>`/`1>`/`2>`）。

## 5. 硬阻断
- 破坏系统可用性命令（如格式化磁盘、直接关机/重启）。
- 越权写受保护路径且无白名单授权。

## 6. `yolo + bash` 特例
- 直接执行。
- 不触发 `ask`、`deny`、风险审批、硬阻断拦截。

## 7. 审批交互契约
当启用交互审批时，必须提供三选项（仅对**策略层 `ask`** 生效）：
1. 同意一次
2. 拒绝
3. 始终同意该命令（记录到项目级 allowlist，仅影响后续策略层决策；危险命令风险审批仍为 y/n）

## 8. “始终同意该命令”规则
- 项目级作用域，不跨项目。
- 按命令名匹配，不按完整参数。
- 大小写不敏感。
- 前置环境变量不影响匹配。
- 绝对路径命令与命令名等价。
- 管道/链式命令需每个子命令均命中。
- `sudo` 不纳入自动放行。

适用范围：
- 仅用于**模型触发的工具调用**（包括自动触发的 `skill`），由策略层 `ask` 驱动的审批交互产生。
- **命令模式 `!`** 不走策略/风险审批链，等价用户在终端直接执行命令，不受 allowlist 影响。

## 9. 决策优先级
1. `yolo + bash` 直接放行。
2. `deny`（策略或硬阻断）。
3. 用户拒绝。
4. 自动触发 skill 免审批例外（前提非 `deny`）。
5. allowlist 命中。
6. 用户同意一次。
7. `ask + auto_approve_ask=true`。
8. 普通 `allow`。
