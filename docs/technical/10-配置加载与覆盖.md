# 10. 配置加载与覆盖（目标态）

## 1. 设计目标

- 以 `config.Default()` 作为**默认值单一来源（SSOT）**。
- `Load()` 仅负责“读取 + 合并 + 归一化 + 环境变量覆盖”。
- 业务层（如 orchestrator/bootstrap）不再复制配置默认值常量。

## 2. 首次启动初始化项目配置

当首次在项目目录运行时，若不存在 `./.coder/config.json`，程序会：

1. 创建 `./.coder/`（若不存在）。
2. 以 `config.Default()` 序列化输出模板到 `./.coder/config.json`。

若目录无写权限或写入失败，仅输出 warning，不阻断后续加载流程。

## 3. 加载顺序

`config.Load()` 的确定性顺序：

1. 内置默认配置：`config.Default()`。
2. 全局配置：`~/.coder/config.json`（存在则 merge）。
3. 项目配置：`./.coder/config.json`（存在则 merge）。
4. `normalize`（补缺省、路径展开、去重与约束校验）。
5. 环境变量覆盖（如 `AGENT_BASE_URL`、`AGENT_MODEL`）。
6. 二次 `normalize`（确保 env 覆盖后仍满足约束）。

## 4. JSONC 支持

- 读取后先移除行注释 `//` 与块注释 `/* ... */`。
- 再使用标准 JSON 反序列化。

## 5. merge 责任边界

- `types`：声明配置结构，不包含 merge 行为。
- `loader`：文件读取、JSONC 清洗、反序列化。
- `merge`：字段级覆盖策略（标量、list、map 规则）。
- `normalize`：约束收敛与路径归一化。
- `env`：环境变量读取与覆盖。

merge 规则：

- 标量：override 为非空/有效值时覆盖 base。
- list：采用“整体替换”或“显式追加”策略，禁止隐式拼接。
- map：按配置块语义处理（例如 `permission.bash` 为整体替换）。

## 6. normalize 规则

- 补默认值：来自 `config.Default()`。
- 路径展开：`~` 展开为 home，统一绝对路径。
- 去重与去空：模型列表、命令列表、路径列表。
- 约束修正：如阈值上下界、最小重试次数等。

## 7. 环境变量覆盖

- `AGENT_BASE_URL`
- `AGENT_MODEL`
- `AGENT_API_KEY`（可回退 `DASHSCOPE_API_KEY`）
- `AGENT_WORKSPACE_ROOT`
- `AGENT_MAX_STEPS`
- `AGENT_CACHE_PATH`

错误处理：

- 非法值立即返回错误（如 `AGENT_MAX_STEPS<=0`）。

## 8. 关键配置块

- `provider`：模型地址/默认模型/超时/模型列表。
- `runtime`：workspace、最大步数、上下文上限。
- `safety`：命令超时、输出上限。
- `compaction`：压缩开关、阈值、保留消息数。
- `workflow`：todo 约束、自动验证、重试次数、验证命令。
- `approval`：交互审批与自动放行策略。
- `permission`：工具权限、bash 策略、allowlist。
- `agent/agents`：模式与 agent profile 定义。
- `skills`：skill 搜索路径。
- `storage`：持久化目录与缓存策略。
- `lsp`：语言服务配置。
- `fetch`：抓取超时、大小限制、默认请求头。

## 9. 兼容与行为变更记录（重构要求）

- 配置重构应保持外部字段兼容，不改 JSON key。
- 若存在行为变化（如默认值修正），必须：
  - 在 PR 描述列出“Before/After”；
  - 在本文件追加兼容说明与迁移建议；
  - 为变化点补充回归测试。

## 10. 运行规则

- `/permissions` 预设：`build`、`plan`（与 `/mode` 联动）。
- `/model <name>` 持久化仅写入 `./.coder/config.json`。
- 默认离线模式不要求 MCP 配置。
