# 10. 配置加载与覆盖（目标态）

## 1. 加载顺序
`config.Load()` 目标态流程：
1. 内置默认配置。
2. 当前路径 `./.coder/config.json`。
3. 若不存在则回退 `~/.coder/config.json`。
4. 归一化。
5. 环境变量覆盖。
6. 二次归一化。

## 2. JSONC 支持
- 解析前去除行注释与块注释。
- 使用标准 JSON 反序列化。

## 3. merge 规则
- 标量字段：非空/有效值覆盖。
- 列表字段：新列表整体覆盖旧列表。
- map 字段：按配置块整体替换。

## 4. normalize 规则
- 补默认值：`max_steps`、`timeout`、`token_limit` 等。
- 路径展开：`~` -> home，统一绝对路径。
- 去重与去空：模型列表、技能路径、命令列表。
- 空白字段清理。

## 5. 环境变量覆盖
- `AGENT_BASE_URL`
- `AGENT_MODEL`
- `AGENT_API_KEY`（可回退 `DASHSCOPE_API_KEY`）
- `AGENT_WORKSPACE_ROOT`
- `AGENT_MAX_STEPS`
- `AGENT_CACHE_PATH`

非法值处理：
- 例如 `AGENT_MAX_STEPS<=0` 直接报错。

## 6. 关键配置块
- `provider`：私有模型地址、默认模型、超时、模型列表。
- `runtime`：workspace、最大步数、上下文上限。
- `safety`：命令超时、输出截断。
- `compaction`：压缩阈值与保留条数。
- `workflow`：复杂任务 todo、自动验证开关与命令、模式轮转。
- `permission`：工具权限与 bash pattern。
- `agents`：agent 定义与默认 agent。
- `skills`：skill 扫描路径（默认开启）。
- `storage`：SQLite 路径。

## 7. 预设与运行规则
- `/permissions` 预设：`strict`、`balanced`、`auto-edit`、`yolo`。
- `/model <name>` 持久化仅写 `./.coder/config.json`。
- 主题/字体不提供配置项：固定 `OpenCode Dark` + 终端默认等宽字体。

## 8. 离线默认建议
- `workflow.verify_commands` 配置白名单命令。
- token 估算默认启发式，精确计数仅作可选增强。
- 不配置 MCP 相关项。
