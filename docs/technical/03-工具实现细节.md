# 03. 工具实现细节（目标态）

## 1. 工具注册与分发
- 统一接口：`tools.Tool`
- 可选审批接口：`tools.ApprovalAware`
- 注册器：`tools.Registry`
  - `DefinitionsFiltered(allowed)`：按 agent 开关暴露工具。
  - `ApprovalRequest(name,args)`：统一拉取工具级审批请求。
  - `Execute(name,args)`：按名执行。

## 2. 内置工具清单
- 文件类：`read` `write` `list` `glob` `grep` `patch`
- 执行类：`bash`
- 任务管理：`todoread` `todowrite`
- 扩展能力：`skill` `task`

说明：目标态不包含 `mcp_proxy`。

## 3. 文件类工具
### `read`
- 输入：`path`
- 输出：`{ok,path,content}`
- 关键约束：路径必须在 workspace 内。

### `write`
- 输入：`path,content`
- 输出：`{ok,path,operation,size,additions,deletions,diff}`
- 行为：全量覆盖写入；返回简化 unified diff。

### `list`
- 输入：`path`（可空）
- 输出：`{ok,path,items[]}`
- 条目字段：`name/path/is_dir/size_bytes`。

### `glob`
- 输入：`pattern`
- 输出：`{ok,matches[]}`
- 关键约束：拒绝绝对路径 pattern。

### `grep`
- 输入：`pattern,path,max_matches`
- 输出：`{ok,count,matches[]}`
- 默认 `max_matches=200`；跳过二进制文件。

### `patch`
- 输入：`patch,dry_run`
- 输出：`{ok,applied,results[]}`
- 行为：按 unified diff 逐文件、逐 hunk 应用。

## 4. `bash` 工具
- 执行器：`/bin/sh -lc <command>`
- 工作目录：workspace root
- 超时：`context.WithTimeout`
- 输出截断：按 `output_limit_bytes` 限制 stdout/stderr

输出结构：
- `ok`
- `command`
- `exit_code`
- `stdout`
- `stderr`
- `truncated`
- `duration_ms`

## 5. `todoread` / `todowrite`
- `todoread`：读取当前 session todo 列表。
- `todowrite`：整表替换。
- 约束：`in_progress` 最多 1 条。

## 6. `skill` 工具
- `action=list`：返回可见 skill 列表。
- `action=load`：返回 `SKILL.md` 内容。
- 审批策略：
  - 显式调用走策略审批链。
  - 自动触发路径可免审批（但仍受 `deny` 约束）。

## 7. `task` 工具
- 输入：`agent,objective`
- 执行：调用子代理 runner。
- 输出契约（目标态）：
  - `ok`
  - `agent`
  - `summary`

说明：`task` 返回契约采用 summary 文本，不使用结构化 `status/artifacts/...` 契约。

## 8. 错误处理约定
- 未知工具：返回 `unknown tool`。
- 参数非法：返回可读 `args` 错误。
- 路径越界：返回权限错误。
- patch 不匹配：返回上下文不匹配错误。
- bash 超时：`exit_code=124`，`ok=false`。
