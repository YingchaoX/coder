# 01. 启动流程与依赖注入（目标态）

## 1. 启动入口
- 入口文件：`cmd/agent/main.go`
- 运行形态：单二进制 + 终端 REPL。

## 2. 配置发现顺序
1. 内置默认配置。
2. 当前路径：`./.coder/config.json`。
3. 家目录回退：`~/.coder/config.json`（仅当前路径不存在时）。
4. 环境变量覆盖。

说明：不再使用 `agent.config.json(c)` 作为目标态主路径。

## 3. 初始化顺序（Fail Fast）
1. i18n 初始化。
2. 配置加载与归一化。
3. 工作区解析与安全沙箱初始化（`security.Workspace`）。
4. SQLite 初始化（建库、建表、索引）。
5. 旧数据迁移（若存在）。
6. Skills 发现（默认开启；失败降级为“无 skill”而不是启动失败）。
7. 权限策略初始化（`permission.Policy`）。
8. Agent 配置解析与生效。
9. Context Assembler 初始化。
10. Provider 初始化（OpenAI SDK + 私有模型地址）。
11. 创建会话元数据并持久化。
12. 工具注册（不包含 MCP）。
13. Orchestrator 构建与回调注入。
14. REPL 主循环启动（读行 → 分发 → 输出回显）；由 `internal/repl` 实现。

## 4. 依赖注入规则
- `TaskTool` 通过 `SetRunner` 注入 `orch.RunSubtask`。
- `TodoReadTool/TodoWriteTool` 通过闭包注入当前 session ID。
- `OnApproval` 注入审批实现（支持交互审批与默认策略）。

## 5. 启动失败策略
- 以下组件初始化失败应直接退出：配置、workspace、provider、sqlite。
- 以下组件初始化失败可降级继续：skills（记录告警，禁用 skill 功能）。
- 所有失败信息需输出可读错误并返回非零退出码。

## 6. 离线最小前置
- 必需：私有模型服务可达、`/bin/sh` 可执行、SQLite 可写目录。
- 可选：`git`（仅影响 `/undo`）。
