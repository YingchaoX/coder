# 00. 总体架构（目标态）

> 说明：本篇描述的是“目标态”架构。若与当前仓库代码或 `docs/requirements/*.md` 中的行为存在差异，以**现有实现 + 需求文档**为基线；文中尚未落地的部分应视为后续规划，而非已实现能力。

## 1. 设计目标
- 离线可运行：在默认无外网的服务器上，以单二进制方式稳定运行。
- 需求对标：严格覆盖需求文档定义的交互、权限、工具、模式与异常行为。
- 最小依赖：除操作系统基础能力（`/bin/sh`、文件系统、可选 `git`）和已部署模型服务外，不引入运行时必需外部组件。
- 可维护：模块边界清晰，策略可配置，行为可测试。

## 2. 非目标
- 不做 IDE 插件形态。
- 不做多进程分布式架构。
- 不引入 MCP 运行链路（目标态移除）。

## 3. 分层与职责
- 启动层：`cmd/agent/main.go`
  - 加载配置、初始化依赖、构建编排器与 REPL 交互层。
- 交互层：REPL 交互层（`internal/repl`，实现终端读行 + 输出到 stdout）
  - 提示符渲染（两行）、按键输入（Enter 换行、Ctrl+D 发送）；非 TTY 下按行或 EOF、输入历史、流式输出到 stdout、颜色约定。
- 编排层：`internal/orchestrator`
  - 回合执行、工具循环、特殊命令分发、自动验证、todo 初始化。
- 模型层：`internal/provider`
  - OpenAI SDK 对接私有模型（OpenAI 兼容接口）。
- 工具层：`internal/tools`
  - 文件读写、补丁、命令执行、todo、skill、task、lsp。
- LSP层：`internal/lsp`
  - LSP Client (JSON-RPC)、Server 生命周期管理、多语言支持。
- 安全层：`internal/security` + `internal/permission`
  - 工作区边界、策略决策、风险审批。
- 上下文层：`internal/contextmgr`
  - 静态上下文拼装、token 估算、压缩。
- 存储层：`internal/storage`
  - SQLite 会话、消息、todo、权限日志持久化。
- 扩展层：`internal/skills`
  - SKILL.md 发现与加载。

## 4. 运行时主数据流
1. REPL 读入用户输入。
2. Orchestrator 判断输入分支：普通对话、`!` 命令、`/` 命令。
3. 普通对话进入模型-工具循环：模型输出 -> 工具执行 -> 结果回灌。
4. 回合结束后产出最终回答，并将状态与消息持久化。
5. 输出按时间顺序写入 stdout（用户消息、助手回复、工具摘要、diff 等），历史通过终端滚动回看。

## 5. 离线可用性约束
- 默认网络假设：仅可访问私有模型服务地址。
- 默认关闭外部依赖能力：
  - 不依赖 MCP。
  - 不依赖外部在线配置中心。
- token 估算策略：优先启发式估算；精确 token 计数仅作为可选增强，不作为功能前置条件。
- 所有核心能力可在“无外网 + 最小系统工具”条件下运行。
- LSP 能力为可选增强：LSP Server 未安装时，LSP 工具自动降级并提示安装，不影响核心功能。
## 6. 目标平台
- Linux: `amd64`、`arm64`
- macOS: `amd64`、`arm64`

## 7. 核心不变量
- 文件工具始终受工作区边界约束。
- 四模式均可用：`plan`、`default`、`auto-edit`、`yolo`。
- `yolo + bash` 始终走全放行路径。
- 自动验证只执行白名单命令。
- `/undo` 仅在检测到 git 可用且当前目录为 git 仓库时启用。
