# 07. 存储与迁移实现（目标态）

## 1. 存储后端
- 后端：SQLite（WAL 模式）
- 目标：单机离线稳定、低运维成本、易备份

初始化：
- 打开数据库
- PRAGMA 设置（`journal_mode=WAL`、`busy_timeout`、`foreign_keys=ON`、`synchronous=NORMAL`）
- 自动建表与索引

## 2. 数据模型
- `sessions`：会话元信息（agent/model/cwd/summary/timestamps）
- `messages`：消息序列（role/content/tool_calls/reasoning）
- `todos`：会话级 todo
- `permission_log`：权限决策审计
- （可选）`command_allowlist`：始终同意命令持久化

## 3. 持久化策略
- 会话创建时写入 `sessions`。
- 每回合完成后执行 `SaveMessages`（覆盖该 session 消息序列）。
- todo 更新通过事务替换（删除旧数据 + 插入新数据）。
- 审批结果写入 `permission_log`，保证可追溯。

## 4. 会话命令支持
- `/new`：创建新 session，切换空上下文。
- `/resume <session-id>`：加载历史消息并恢复上下文。

约束：
- `/resume` 参数仅支持 session ID，不支持别名或索引。

## 5. 迁移策略
- 启动时可扫描旧 JSON 会话并迁移到 SQLite。
- 已存在 session ID 跳过。
- 单条迁移失败不影响其它会话迁移。

## 6. `/undo` 与存储边界
- `/undo` 依赖 git 工作区状态，不依赖 SQLite 快照回滚。
- git 不可用或非仓库时，命令直接返回不可用提示。
