# 05. 上下文与压缩实现（目标态）

## 1. 静态上下文组装
`contextmgr.Assembler.StaticMessages()` 固定顺序：
1. System Prompt
2. 项目规则（`<workspace>/AGENTS.md`）
3. 全局规则文件
4. 配置指定 instruction files

扩展说明：
- Skills 默认开启时，模型可通过工具先 `list` 再 `load`；不在静态上下文一次性灌入全部 skill 全文。

## 2. Token 估算策略（离线优先）
- 默认：启发式估算（不依赖外部资源）。
- 可选增强：本地可用时启用 tiktoken 精确计数。
- 任何情况下都不允许因 token 计数组件不可用而阻塞主流程。

## 3. 自动压缩触发
每次模型调用前检查：
- `estimated_tokens > context_limit * threshold` 时触发压缩。

## 4. 压缩策略
- 默认：规则摘要压缩（稳定、离线可用）。
- 可选：LLM 压缩（仅当 provider 可用且配置开启）。
- 回退：LLM 失败时回退规则摘要。

压缩结果：
- 生成一条 `[COMPACTION_SUMMARY]` assistant 消息。
- 保留最近 `N` 条消息（`recent_messages`）。

## 5. Tool 输出裁剪
- 对 `tool` 消息的大字段做长度裁剪（`content/stdout/stderr`）。
- 非 JSON 文本按 rune 截断。
- 保留错误关键字段，避免压缩后丢失故障定位信息。

## 6. 强制压缩
- `/compact` 触发一次显式压缩。
- 返回摘要文本并写入会话。
